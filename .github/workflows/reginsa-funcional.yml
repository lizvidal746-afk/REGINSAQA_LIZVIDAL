name: REGINSA Functional Scale

on:
  workflow_dispatch:
    inputs:
      caso:
        description: "Caso funcional (01|02|03|04)"
        type: choice
        options:
          - "01"
          - "02"
          - "03"
          - "04"
        required: false
        default: "01"
      workers:
        description: "Playwright workers"
        required: false
        default: "6"
      repeat_each:
        description: "Playwright repeat-each"
        required: false
        default: "30"
      pool_target:
        description: "Pool target size"
        required: false
        default: "1200"

jobs:
  functional-scale:
    runs-on: windows-latest
    timeout-minutes: 120
    env:
      REGINSA_URL: ${{ secrets.REGINSA_URL }}
      BASE_URL: ${{ secrets.REGINSA_URL }}
      REGINSA_USER_1: ${{ secrets.REGINSA_USER_1 }}
      REGINSA_PASS_1: ${{ secrets.REGINSA_PASS_1 }}
      REGINSA_USER_2: ${{ secrets.REGINSA_USER_2 }}
      REGINSA_PASS_2: ${{ secrets.REGINSA_PASS_2 }}
      REGINSA_USER_3: ${{ secrets.REGINSA_USER_3 }}
      REGINSA_PASS_3: ${{ secrets.REGINSA_PASS_3 }}
      REGINSA_USER_4: ${{ secrets.REGINSA_USER_4 }}
      REGINSA_PASS_4: ${{ secrets.REGINSA_PASS_4 }}
      REGINSA_USER_5: ${{ secrets.REGINSA_USER_5 }}
      REGINSA_PASS_5: ${{ secrets.REGINSA_PASS_5 }}
      REGINSA_USER_6: ${{ secrets.REGINSA_USER_6 }}
      REGINSA_PASS_6: ${{ secrets.REGINSA_PASS_6 }}
      REGINSA_USER_7: ${{ secrets.REGINSA_USER_7 }}
      REGINSA_PASS_7: ${{ secrets.REGINSA_PASS_7 }}
      REGINSA_USER_8: ${{ secrets.REGINSA_USER_8 }}
      REGINSA_PASS_8: ${{ secrets.REGINSA_PASS_8 }}
      REGINSA_POOL_TARGET: ${{ github.event.inputs.pool_target || '600' }}
      REGINSA_STRICT_VERIFY: '1'
      REGINSA_SKIP_LIST_VERIFY: '1'
      REGINSA_REQUIRE_API_CREATE: '1'
      REGINSA_ALLOW_UI_EVENTUAL: '1'
      REGINSA_CONFIRMAR_API_RETRIES: '8'
      REGINSA_CONFIRMAR_API_WAIT_MS: '1500'
      REGINSA_CONFIRMAR_API_RETRIES_EXT: '20'
      REGINSA_CONFIRMAR_API_WAIT_MS_EXT: '2000'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Install Playwright browser
        run: npx playwright install chromium

      - name: Reset operational run
        run: npm run iteracion:reiniciar

      - name: Prewarm data pool
        run: npm run pool:prewarm

      - name: Validate credentials presence
        shell: pwsh
        run: |
          $pairs = @(
            @{ U = "$env:REGINSA_USER"; P = "$env:REGINSA_PASS"; N = "REGINSA_USER/REGINSA_PASS" },
            @{ U = "$env:REGINSA_USER_1"; P = "$env:REGINSA_PASS_1"; N = "REGINSA_USER_1/REGINSA_PASS_1" },
            @{ U = "$env:REGINSA_USER_2"; P = "$env:REGINSA_PASS_2"; N = "REGINSA_USER_2/REGINSA_PASS_2" },
            @{ U = "$env:REGINSA_USER_3"; P = "$env:REGINSA_PASS_3"; N = "REGINSA_USER_3/REGINSA_PASS_3" },
            @{ U = "$env:REGINSA_USER_4"; P = "$env:REGINSA_PASS_4"; N = "REGINSA_USER_4/REGINSA_PASS_4" },
            @{ U = "$env:REGINSA_USER_5"; P = "$env:REGINSA_PASS_5"; N = "REGINSA_USER_5/REGINSA_PASS_5" },
            @{ U = "$env:REGINSA_USER_6"; P = "$env:REGINSA_PASS_6"; N = "REGINSA_USER_6/REGINSA_PASS_6" },
            @{ U = "$env:REGINSA_USER_7"; P = "$env:REGINSA_PASS_7"; N = "REGINSA_USER_7/REGINSA_PASS_7" },
            @{ U = "$env:REGINSA_USER_8"; P = "$env:REGINSA_PASS_8"; N = "REGINSA_USER_8/REGINSA_PASS_8" }
          )

          $ok = $pairs | Where-Object { -not [string]::IsNullOrWhiteSpace($_.U) -and -not [string]::IsNullOrWhiteSpace($_.P) }
          if (-not $ok) {
            throw "No se detectó ningún par de credenciales en Secrets. Configure REGINSA_USER/REGINSA_PASS o REGINSA_USER_n/REGINSA_PASS_n (n=1..8)."
          }

          Write-Host "Credenciales detectadas en: $($ok[0].N)"

      - name: Validate parallel credential slots for workers>=7
        shell: pwsh
        run: |
          $runWorkers = [int]("${{ github.event.inputs.workers || '6' }}")
          if ($runWorkers -lt 7) {
            Write-Host "workers=$runWorkers no requiere validación de slots 7 y 8."
            exit 0
          }

          $missing = @()
          if ([string]::IsNullOrWhiteSpace("$env:REGINSA_USER_7")) { $missing += 'REGINSA_USER_7' }
          if ([string]::IsNullOrWhiteSpace("$env:REGINSA_PASS_7")) { $missing += 'REGINSA_PASS_7' }
          if ([string]::IsNullOrWhiteSpace("$env:REGINSA_USER_8")) { $missing += 'REGINSA_USER_8' }
          if ([string]::IsNullOrWhiteSpace("$env:REGINSA_PASS_8")) { $missing += 'REGINSA_PASS_8' }

          if ($missing.Count -gt 0) {
            throw "workers=$runWorkers requiere pool 1..8 completo. Faltan secrets: $($missing -join ', ')"
          }

          Write-Host "Pool paralelo validado para workers=$runWorkers (slots 7 y 8 presentes)."

      - name: Validate REGINSA_URL DNS
        shell: pwsh
        run: |
          $rawUrl = "$env:REGINSA_URL"
          if ([string]::IsNullOrWhiteSpace($rawUrl)) {
            throw "REGINSA_URL no está definido en Secrets."
          }

          $url = $rawUrl.Trim()
          if ($url -notmatch '^https?://') { $url = "https://$url" }

          try {
            $uri = [System.Uri]$url
          } catch {
            throw "REGINSA_URL no es válida: $rawUrl"
          }

          try {
            Resolve-DnsName -Name $uri.Host -ErrorAction Stop | Out-Null
            Write-Host "Dominio resolvible: $($uri.Host)"
          } catch {
            throw "No se pudo resolver el dominio '$($uri.Host)' desde GitHub runner. Si es red interna/VPN, use runner self-hosted con acceso institucional."
          }

      - name: Run functional scale
        shell: pwsh
        env:
          RUN_CASO: ${{ github.event.inputs.caso || '01' }}
          RUN_WORKERS: ${{ github.event.inputs.workers || '6' }}
          RUN_REPEAT: ${{ github.event.inputs.repeat_each || '10' }}
        run: |
          $caso = "$env:RUN_CASO"
          $workers = "$env:RUN_WORKERS"
          $repeat = "$env:RUN_REPEAT"

          switch ($caso) {
            '01' { npm run test:01:scale -- --workers=$workers --repeat-each=$repeat --project=chromium; break }
            '02' { npm run test:02:scale -- --workers=$workers --repeat-each=$repeat --project=chromium; break }
            '03' { npm run test:03:scale -- --workers=$workers --repeat-each=$repeat --project=chromium; break }
            '04' { npm run test:04:scale -- --workers=$workers --repeat-each=$repeat --project=chromium; break }
            Default { throw "Valor de 'caso' inválido: $caso" }
          }

      - name: Evaluate test outcomes
        if: always() && hashFiles('test-results/results.json') != ''
        run: node scripts/evaluate-playwright-results.js

      - name: Upload artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: functional-scale-artifacts
          path: |
            playwright-report
            allure-report
            allure-results
            test-results
            reportes
          if-no-files-found: warn

trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: ubuntu-latest

variables:
  NODE_VERSION: '20.x'

stages:
  - stage: Build
    jobs:
      - job: Build
        steps:
          - checkout: self
          - task: NodeTool@0
            inputs:
              versionSpec: '$(NODE_VERSION)'
          - script: npm ci
            displayName: Instalar dependencias
          - script: npm run build
            displayName: Build

  - stage: UnitTests
    dependsOn: Build
    jobs:
      - job: UnitTests
        steps:
          - checkout: self
          - task: NodeTool@0
            inputs:
              versionSpec: '$(NODE_VERSION)'
          - script: npm ci
            displayName: Instalar dependencias
          - script: npm run test:unit
            displayName: Unit tests

  - stage: PlaywrightTests
    dependsOn: UnitTests
    jobs:
      - job: Playwright
        steps:
          - checkout: self
          - task: NodeTool@0
            inputs:
              versionSpec: '$(NODE_VERSION)'
          - script: npm ci
            displayName: Instalar dependencias
          - script: npx playwright install --with-deps
            displayName: Instalar browsers
          - script: npm run test:e2e
            displayName: Ejecutar Playwright
          - task: PublishTestResults@2
            condition: always()
            inputs:
              testResultsFormat: JUnit
              testResultsFiles: '**/junit.xml'
              failTaskOnFailedTests: true
          - task: PublishPipelineArtifact@1
            condition: always()
            inputs:
              targetPath: test-results
              artifact: test-results

  - stage: K6Tests
    dependsOn: PlaywrightTests
    jobs:
      - job: K6
        steps:
          - checkout: self
          - script: |
              sudo gpg -k
              sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
              echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
              sudo apt-get update
              sudo apt-get install -y k6
            displayName: Instalar K6
          - script: k6 run docs/plantillas/k6_smoke_reginsa.js --env BASE_URL=$(BASE_URL)
            displayName: Ejecutar K6

  - stage: SonarQubeAnalysis
    dependsOn: K6Tests
    jobs:
      - job: Sonar
        steps:
          - checkout: self
          - task: SonarQubePrepare@5
            inputs:
              SonarQube: SONARQUBE_SERVICE_CONNECTION
              scannerMode: CLI
              configMode: manual
              cliProjectKey: REGINSA_QA
              cliProjectName: REGINSA_QA
              cliSources: .
          - task: SonarQubeAnalyze@5
            inputs:
              jdkversion: JAVA_HOME_17_X64
          - task: SonarQubePublish@5
            inputs:
              pollingTimeoutSec: '300'

  - stage: QualityGate
    dependsOn: SonarQubeAnalysis
    jobs:
      - job: Gate
        steps:
          - script: echo Quality gate validado
            displayName: Validaci√≥n final
